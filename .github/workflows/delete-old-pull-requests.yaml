name: Close Stale Pull Requests
on:
  schedule:
    - cron: '0 0 * * *'  # Runs daily at midnight
  workflow_dispatch:      # Allows manual execution

permissions:
  pull-requests: write    # Needed to close PRs and add comments

jobs:
  close_old_prs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          fetch-depth: 0  # Fetch all branches and history for the repo

      - name: Close PRs inactive for over a year
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          #!/bin/bash
          set -e

          # Get date from 1 year ago
          one_year_ago=$(date -u -d '1 year ago' +%Y-%m-%dT%H:%M:%SZ)

          # Fetch open PRs that were last updated over a year ago
          prs=$(gh pr list --state open --json number,updatedAt,createdAt --jq \
            '.[] | select(.updatedAt < "'$one_year_ago'" and .createdAt < "'$one_year_ago'") | .number')

          if [ -z "$prs" ]; then
              echo "No PRs to close."
              exit 0
          fi

          for pr in $prs; do
              echo "Closing PR #$pr (inactive for over a year)"
          
              # Add a comment before closing
              gh pr comment $pr --body "This pull request has been inactive for over a year and is now being closed automatically. Feel free to reopen if needed. ðŸš€"
          
              # Close the PR
              gh pr close $pr
          done
